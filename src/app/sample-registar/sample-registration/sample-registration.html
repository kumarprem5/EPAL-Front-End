<!-- components/sample-registration/sample-registration.html -->

<app-sample-header></app-sample-header>

<div class="page-wrapper">
  <div class="page-content">

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         STEP INDICATOR
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="step-trail">
      <div class="step-node" [class.active]="true" [class.done]="submitSuccess">
        <div class="node-circle">
          <span *ngIf="!submitSuccess">01</span>
          <span *ngIf="submitSuccess">‚úì</span>
        </div>
        <span class="node-label">Sample Details</span>
      </div>
      <div class="step-line" [class.done]="submitSuccess"></div>
      <div class="step-node" [class.active]="submitSuccess" [class.done]="submitSuccess && generalInfoSaved">
        <div class="node-circle">
          <span *ngIf="!(submitSuccess && generalInfoSaved)">02</span>
          <span *ngIf="submitSuccess && generalInfoSaved">‚úì</span>
        </div>
        <span class="node-label">General Info</span>
      </div>
      <div class="step-line" [class.done]="submitSuccess && generalInfoSaved"></div>
      <div class="step-node" [class.active]="submitSuccess && generalInfoSaved">
        <div class="node-circle">03</div>
        <span class="node-label">Result Parameters</span>
      </div>
    </div>

    <!-- GLOBAL ALERT -->
    <div *ngIf="uiMessage"
         class="ui-alert"
         [class.success]="uiMessageType === 'success'"
         [class.error]="uiMessageType === 'error'">
      <span class="alert-icon">{{ uiMessageType === 'success' ? '‚úì' : '‚úï' }}</span>
      {{ uiMessage }}
    </div>


    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         SECTION 1 ‚Äî SAMPLE REGISTRATION
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="section-card" id="section-sample">
      <div class="section-header">
        <div class="header-left">
          <span class="section-badge">01</span>
          <div>
            <h2 class="section-title">Register New Sample</h2>
            <p class="section-sub">Fill in project and sample details</p>
          </div>
        </div>
        <div class="registered-tag" *ngIf="submitSuccess">
          <span class="dot"></span> Registered
          <span class="tag-numbers">{{ registeredSampleNumber }} ¬∑ {{ registeredReportNumber }}</span>
        </div>
      </div>

      <form [formGroup]="sampleForm">

        <div class="form-row">
          <div class="form-group full-width">
            <label for="projectName">Project Name <span class="req">*</span></label>
            <input type="text" id="projectName" formControlName="projectName"
                   [class.invalid]="isFieldInvalid('projectName')"
                   placeholder="Enter project name" />
            <span class="err-msg" *ngIf="isFieldInvalid('projectName')">
              Project name is required (min 3 chars)
            </span>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group full-width">
            <label for="address">Address <span class="req">*</span></label>
            <textarea id="address" formControlName="address" rows="2"
                      [class.invalid]="isFieldInvalid('address')"
                      placeholder="Enter full address"></textarea>
            <span class="err-msg" *ngIf="isFieldInvalid('address')">
              Address is required (min 5 chars)
            </span>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group full-width">
            <label for="sampleDescription">Sample Description <span class="req">*</span></label>
            <div class="select-wrap">
              <select id="sampleDescription"
                      formControlName="sampleDescription"
                      [class.invalid]="isFieldInvalid('sampleDescription')"
                      (change)="onSampleDescriptionChange($event)">
                <option value="">
                  {{ loadingDescriptions ? 'Loading descriptions‚Ä¶' : 'Select sample description' }}
                </option>
                <option *ngFor="let d of sampleDescriptions" [value]="d.sampleDescription">
                  {{ d.sampleDescription }}
                </option>
              </select>
              <span class="select-arrow">‚ñæ</span>
            </div>
            <span class="err-msg" *ngIf="isFieldInvalid('sampleDescription')">
              Sample description is required
            </span>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group full-width">
            <label for="samplingAndAnalysisProtocol">Sampling &amp; Analysis Protocol</label>
            <input type="text" id="samplingAndAnalysisProtocol"
                   formControlName="samplingAndAnalysisProtocol"
                   placeholder="Auto-filled from sample description" />
          </div>
        </div>

        <div class="form-row two-col">
          <div class="form-group">
            <label for="formatNumber">Format Number</label>
            <input type="text" id="formatNumber"
                   formControlName="formatNumber"
                   placeholder="Auto-filled from sample description" />
          </div>
          <div class="form-group">
            <label for="partyReferenceNumber">Party Reference Number</label>
            <input type="text" id="partyReferenceNumber"
                   formControlName="partyReferenceNumber"
                   placeholder="e.g. PRN-2024" />
          </div>
        </div>

        <div class="form-row two-col">
          <div class="form-group">
            <label for="dateOfReceiving">Date of Receiving <span class="req">*</span></label>
            <input type="date" id="dateOfReceiving" formControlName="dateOfReceiving"
                   [class.invalid]="isFieldInvalid('dateOfReceiving')" />
            <span class="err-msg" *ngIf="isFieldInvalid('dateOfReceiving')">Date of receiving is required</span>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-ghost" (click)="onReset()" [disabled]="isSavingAll">
            Reset
          </button>
        </div>
      </form>
    </div>


    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         SECTION 2 ‚Äî GENERAL INFORMATION
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="section-card" id="section-info">

      <div class="section-header">
        <div class="header-left">
          <span class="section-badge">02</span>
          <div>
            <h2 class="section-title">General Information</h2>
            <p class="section-sub">Select a sample description to load parameters</p>
          </div>
        </div>
        <div class="badge-count" *ngIf="informations.length > 0">
          {{ informations.length }} entries
        </div>
        <div class="loader-inline" *ngIf="isLoadingDropDowns || isLoadingInfo">
          <div class="mini-spinner"></div> <span>Loading‚Ä¶</span>
        </div>
      </div>

      <!-- Add row from dropdown -->
      <div class="inline-add-form" *ngIf="activeSampleDescription">
        <div class="add-field">
          <label>General Info</label>
          <div class="select-wrap">
            <select class="form-input"
                    [ngModel]="selectedInfoParam"
                    (ngModelChange)="onInfoParamSelect($event)">
              <option [ngValue]="null" disabled>‚Äî Select parameter ‚Äî</option>
              <option *ngFor="let p of generalInfoDropDowns" [ngValue]="p">{{ p.parameterName }}</option>
            </select>
            <span class="select-arrow">‚ñæ</span>
          </div>
        </div>
        <div class="add-field">
          <label>Value</label>
          <input type="text" class="form-input" placeholder="Enter value" [(ngModel)]="newInfo.value" />
        </div>
        <button class="btn btn-accent"
                (click)="addInformationRow()"
                [disabled]="!newInfo.name">
          Ôºã Add Row
        </button>
      </div>

      <div class="empty-row"
           *ngIf="!isLoadingInfo && !isLoadingDropDowns && informations.length === 0">
        Select a sample description above to load general information parameters.
      </div>

      <div class="table-wrap" *ngIf="!isLoadingInfo && informations.length > 0">
        <table class="data-table">
          <thead>
            <tr>
              <th class="th-sno">#</th>
              <th>Sample Information</th>
              <th>Value</th>
              <th class="th-status">Status</th>
              <th class="th-actions">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let info of informations; let i = index"
                [class.unsaved-row]="isInfoRowUnsaved(info)">
              <td class="td-sno">{{ i + 1 }}</td>
              <td><input [(ngModel)]="info.name"  class="cell-input" placeholder="Name" /></td>
              <td><input [(ngModel)]="info.value" class="cell-input" placeholder="Value" /></td>
              <td class="td-status">
                <span class="badge-saved"   *ngIf="!isInfoRowUnsaved(info)">‚úì Saved</span>
                <span class="badge-unsaved" *ngIf="isInfoRowUnsaved(info)">‚óè Unsaved</span>
              </td>
              <td class="td-actions">
                <button class="btn-icon-act del" (click)="removeInformation(info, i)" title="Remove">üóë</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>


    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         SECTION 3 ‚Äî RESULT PARAMETERS (TestParameterResult)
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="section-card" id="section-results">

      <div class="section-header">
        <div class="header-left">
          <span class="section-badge">03</span>
          <div>
            <h2 class="section-title">Result Parameters</h2>
            <p class="section-sub">Pre-filled from sample description ‚Äî edit values and save</p>
          </div>
        </div>
        <div class="badge-count" *ngIf="testParameterResults.length > 0">
          {{ testParameterResults.length }} parameters
        </div>
        <div class="loader-inline" *ngIf="isLoadingResultDropDowns">
          <div class="mini-spinner"></div> <span>Loading‚Ä¶</span>
        </div>
      </div>

      <!-- Add from dropdown -->
      <div class="inline-add-form result-add" *ngIf="activeSampleDescription">
        <div class="add-field">
          <label>Add Parameter</label>
          <div class="select-wrap">
            <select class="form-input"
                    [ngModel]="selectedResultDropDown"
                    (ngModelChange)="onResultDropDownSelect($event)">
              <option [ngValue]="null" disabled>‚Äî Select parameter to add ‚Äî</option>
              <option *ngFor="let r of resultDropDowns" [ngValue]="r">{{ r.name }}</option>
            </select>
            <span class="select-arrow">‚ñæ</span>
          </div>
        </div>
        <button class="btn btn-accent"
                (click)="addResultFromDropDown()"
                [disabled]="!selectedResultDropDown">
          Ôºã Add Selected
        </button>
        <button class="btn btn-ghost" (click)="addBlankResult()">
          Ôºã Custom Row
        </button>
      </div>

      <div class="loader-row" *ngIf="isLoadingResults">
        <div class="mini-spinner"></div>
        <span>Loading saved parameters‚Ä¶</span>
      </div>

      <div class="empty-row"
           *ngIf="!isLoadingResults && !isLoadingResultDropDowns && testParameterResults.length === 0">
        Select a sample description above to load result parameters.
      </div>

      <!-- ‚úÖ TABLE with TestParameterResult columns matching TestParameterResultRequest -->
      <div class="table-wrap" *ngIf="!isLoadingResults && testParameterResults.length > 0">
        <table class="data-table result-table">
          <thead>
            <tr>
              <th class="th-sno">#</th>
              <th>Parameter Name</th>
              <th class="th-unit">Unit</th>
              <th>Result Value</th>
              <th>Detection Limit</th>
              <th>Specification Limit</th>
              <th>Protocol Used</th>
              <th class="th-complies">Complies</th>
              <th>Remarks</th>
              <th class="th-status">Status</th>
              <th class="th-actions">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let r of testParameterResults; let i = index"
                [class.unsaved-row]="isTestResultRowUnsaved(r)">
              <td class="td-sno">{{ i + 1 }}</td>

              <!-- parameterName ‚Äî pre-filled, still editable -->
              <td>
                <input [(ngModel)]="r.parameterName"
                       class="cell-input"
                       placeholder="Parameter name" />
              </td>

              <!-- unit ‚Äî pre-filled, still editable -->
              <td>
                <input [(ngModel)]="r.unit"
                       class="cell-input cell-unit"
                       placeholder="Unit" />
              </td>

              <!-- resultValue ‚Äî user enters this -->
              <td>
                <input [(ngModel)]="r.resultValue"
                       class="cell-input"
                       placeholder="e.g. 6.82 / Absent" />
              </td>

              <!-- detectionLimit ‚Äî user enters this -->
              <td>
                <input [(ngModel)]="r.detectionLimit"
                       class="cell-input"
                       placeholder="e.g. DL-0.02" />
              </td>

              <!-- specificationLimit ‚Äî pre-filled from standarded, editable -->
              <td>
                <input [(ngModel)]="r.specificationLimit"
                       class="cell-input"
                       placeholder="e.g. 6.0 to 8.5" />
              </td>

              <!-- protocolUsed ‚Äî pre-filled from protocal, editable -->
              <td>
                <input [(ngModel)]="r.protocolUsed"
                       class="cell-input"
                       placeholder="e.g. IS:3025 Part-11" />
              </td>

              <!-- complies ‚Äî checkbox -->
              <td class="td-complies">
                <label class="toggle">
                  <input type="checkbox" [(ngModel)]="r.complies" />
                  <span class="toggle-track"></span>
                </label>
              </td>

              <!-- remarks ‚Äî user enters this -->
              <td>
                <input [(ngModel)]="r.remarks"
                       class="cell-input"
                       placeholder="Remarks" />
              </td>

              <td class="td-status">
                <span class="badge-saved"   *ngIf="!isTestResultRowUnsaved(r)">‚úì Saved</span>
                <span class="badge-unsaved" *ngIf="isTestResultRowUnsaved(r)">‚óè Unsaved</span>
              </td>
              <td class="td-actions">
                <button class="btn-icon-act del"
                        (click)="deleteTestResult(r, i)"
                        title="Remove">üóë</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>


    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         GLOBAL SAVE ALL BUTTON
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="global-save-bar">
      <div class="save-bar-info" *ngIf="submitSuccess">
        <span class="dot success"></span>
        Sample registered: <strong>{{ registeredSampleNumber }}</strong>
        &nbsp;¬∑&nbsp; Report: <strong>{{ registeredReportNumber }}</strong>
      </div>
      <div class="save-bar-info" *ngIf="!submitSuccess">
        <span class="dot pending"></span>
        Fill in all sections, then click Save All to register &amp; save everything
      </div>
      <button class="btn btn-save-all"
              (click)="saveAll()"
              [disabled]="isSavingAll">
        <span class="btn-spinner" *ngIf="isSavingAll"></span>
        <span>{{ isSavingAll ? 'Saving‚Ä¶' : 'üíæ Save All' }}</span>
      </button>
    </div>

  </div>
</div>